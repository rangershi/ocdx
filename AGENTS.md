# Repository Agent Guide (ocdx)

This repo is an OpenCode plugin published as the npm package `ocdx`.
Primary language: TypeScript (ESM). Build output: `dist/`.

## Commands

Package manager: `pnpm` (see `package.json#packageManager`).

- Install
  - `pnpm install`
- Build (also acts as typecheck)
  - `pnpm run build`
  - Output: `dist/` (TypeScript `declaration` + `declarationMap` enabled)
- Clean build output
  - `pnpm run clean`
- Lint
  - `pnpm run lint`
  - Note: `no-console` is an error (see `eslint.config.js`)
- Format
  - Write: `pnpm run format`
  - Check (CI-style): `pnpm run format:check`

Packaging/publishing:

- Create tarball (runs `clean` + `build` via `prepack`)
  - `pnpm pack`
- Publish
  - `pnpm publish`
  - Alternative helper: `./publish.sh --token "npm_xxx" [--otp 123456]`

### Run A Single Check (ad-hoc)

There is no dedicated script for these, but they follow the repo toolchain.

- Typecheck only (no emit): `pnpm exec tsc -p tsconfig.json --noEmit`
- Lint one file: `pnpm exec eslint "src/path/to/file.ts"`
- Format-check one file: `pnpm exec prettier --check "src/path/to/file.ts"`
- Format one file: `pnpm exec prettier --write "src/path/to/file.ts"`

### Tests

No test runner / test script is configured in this repo (no `test` script in `package.json`).
If you add tests later, also document:

- the canonical `pnpm run test` command
- how to run a single test (framework-specific)

## Repo Structure

- `src/`: source of the plugin (edit here)
- `dist/`: compiled output used by consumers (generated by `pnpm run build`)
- `@asset/`: packaged assets copied on install (see `scripts/postinstall.mjs`)
- `docs/`: documentation for the PR review loop

## Runtime Prereqs (pr-review-loop)

The `/pr-review-loop` command executes external CLIs via Bun's `$` shell:

- Requires GitHub CLI: `gh` installed and authenticated (`gh auth login`)
- Requires `dx` CLI with `dx lint` and `dx build` subcommands
- Requires a clean git worktree (the tool refuses to run when `git status --porcelain` is non-empty)

Reference: `src/pr-review-loop/preflight.ts`.

## Release / Versioning

- Version tracking: `.release-please-manifest.json`
- Changelog: `CHANGELOG.md`
- Packaging relies on `prepack` (runs `clean` + `build`) so `dist/` is present in tarballs.

## Code Style

### Language / TypeScript

- Keep code compatible with Node >= 20 and ESM (`"type": "module"` in `package.json`).
- TypeScript is `strict: true` (see `tsconfig.json`). Prefer real types over `any`.
- Avoid weakening type safety:
  - Do not add `as any`, `@ts-ignore`, or `@ts-expect-error`.
  - If a type is hard, improve the type/interface instead of casting.

### Imports

- Use ESM imports.
- Prefer `import type { ... }` for type-only imports.
- Keep imports grouped and readable:
  - external packages first
  - then local imports
  - then Node built-ins
  - (match existing file-local style; don't reorder aggressively unless you touched that block)

### Formatting

Formatting is enforced by Prettier (see `.prettierrc`). Key settings:

- semicolons
- single quotes
- trailing commas (es5)
- print width ~100

Run `pnpm run format` after edits.

### Naming

- Types/interfaces: PascalCase (e.g. `ConfigError`, `PRInfo`)
- Functions/variables: camelCase (e.g. `loadOcdxConfigStrict`, `parseModelString`)
- Constants: SCREAMING_SNAKE_CASE when truly constant (rare in this repo)

### Error Handling

- Prefer explicit, user-actionable error messages.
- Use typed errors when appropriate:
  - This repo uses `ConfigError` (see `src/config.ts`) to attach `code`, `configPath`, and `exampleJson`.
- Keep `catch` blocks intentional:
  - Either return a safe default (when that's the design) or surface a useful error.
  - Don't swallow errors silently unless the function explicitly documents "best-effort".

### Logging / Console

- ESLint forbids `console.*` in JS/TS (`no-console: error`).
- For scripts, prefer `process.stderr.write(...)` for diagnostics.
- For plugin tools, return formatted strings as tool output (see patterns in `src/index.ts`).

## Safety & Hygiene

- Do not commit secrets.
  - `.env*` is ignored by git; keep tokens out of the repo.
  - `./publish.sh` accepts an npm token; do not hardcode it anywhere.
- Don't edit generated output unless explicitly requested.
  - Prefer editing `src/` and rebuilding `dist/` via `pnpm run build`.

## OpenCode Plugin Notes

- Dependency sandbox: `.opencode/package.json` is used by OpenCode/Bun to install plugin deps.
- Config resolution (first found wins):
  - project: `.opencode/ocdx/config.json`
  - global: `~/.config/opencode/ocdx/config.json` (or `XDG_CONFIG_HOME`)
  - bundled fallback: `@asset/config.json`
  - reference: `src/config.ts`
- Bundled assets: `scripts/postinstall.mjs` copies `@asset/` into `~/.config/opencode/ocdx/` (or `XDG_CONFIG_HOME`).
- Prompt templates shipped with the package:
  - source: `src/prompts/pr-review-loop/*.md`
  - bundled: `@asset/prompt/*.md`

## Cursor / Copilot Rules

No Cursor rules found (`.cursor/rules/`, `.cursorrules`).
No Copilot instructions found (`.github/copilot-instructions.md`).
